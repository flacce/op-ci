#!/bin/bash
#
# ============================================================================
# 脚本名称: 07-compile.sh
# 功能描述: 编译固件（多核 → 单核重试机制）
# ============================================================================
# 作用:
#   1. 显示当前 CPU 核心数
#   2. 尝试多核编译（速度快）
#   3. 失败则自动切换到单核详细模式（便于排查错误）
# ============================================================================
# 编译策略:
#   - make -j$(nproc)：使用所有 CPU 核心并行编译（速度快）
#   - make -j1 V=s：单核详细模式（输出所有编译日志，便于排查错误）
# ============================================================================
#

set -e  # 遇到错误立即退出

echo "========================================="
echo "🔨 编译固件..."
echo "========================================="

# 进入 OpenWrt 源码目录
cd openwrt

# 显示当前 CPU 核心数
CORES=$(nproc)
echo "CPU 核心数: $CORES"

# 🔥 尝试多核编译，失败则自动切换到单核详细模式（V=s）重试
echo "开始编译（多核模式）..."
if ! make -j$CORES; then
    echo "⚠️  多核编译失败，切换到单核详细模式重试..."
    make -j1 V=s
fi

echo "✅ 固件编译完成！"

