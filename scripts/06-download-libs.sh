#!/bin/bash
#
# ============================================================================
# è„šæœ¬åç§°: 06-download-libs.sh
# åŠŸèƒ½æè¿°: ä¸‹è½½ç¼–è¯‘æ‰€éœ€çš„ä¾èµ–åŒ…
# ============================================================================
# ä½œç”¨:
#   1. ä½¿ç”¨å¤šçº¿ç¨‹ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…åˆ° dl/ ç›®å½•
#   2. æ˜¾ç¤ºä¸‹è½½å¤±è´¥çš„æ–‡ä»¶ï¼ˆå°äº 1KB çš„ç©ºæ–‡ä»¶ï¼‰
#   3. æ¸…ç†ä¸‹è½½å¤±è´¥çš„æ®‹ç•™æ–‡ä»¶
# ============================================================================
#

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "========================================="
echo "ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–..."
echo "========================================="

# è¿›å…¥ OpenWrt æºç ç›®å½•
cd openwrt

# æ¸…ç†æŸåçš„ Go æ¨¡å—ç¼“å­˜
echo "[1/4] æ¸…ç†æŸåçš„ Go æ¨¡å—ç¼“å­˜..."

# æ¸…ç† mosdns ç›¸å…³çš„æ‰€æœ‰ Go æ¨¡å—ç¼“å­˜
if [ -d "dl/go-mod-cache/github.com/IrineSistiana" ]; then
    echo "ğŸ§¹ æ¸…ç† mosdns (IrineSistiana) ç›¸å…³ç¼“å­˜..."
    rm -rf dl/go-mod-cache/github.com/IrineSistiana
    echo "âœ… å·²æ¸…ç† IrineSistiana/* ç¼“å­˜"
fi

# æ¸…ç†å¯èƒ½æŸåçš„ä¾èµ–åŒ…ç¼“å­˜
CORRUPT_MODULES=(
    "github.com/mdlayher/socket@v0.5.1"
    "github.com/google/nftables"
    "golang.org/x/net"
    "golang.org/x/time"
    "go4.org/netipx"
)

for module in "${CORRUPT_MODULES[@]}"; do
    # è½¬æ¢ä¸ºç›®å½•è·¯å¾„æ ¼å¼ (å¤„ç† golang.org/x ç­‰ç‰¹æ®Šè·¯å¾„)
    module_path=$(echo "$module" | cut -d'@' -f1)
    module_dir="dl/go-mod-cache/${module_path}"
    
    if [ -d "$module_dir" ]; then
        echo "ğŸ§¹ æ¸…ç† ${module_path} ç¼“å­˜..."
        rm -rf "$module_dir"
        echo "âœ… å·²æ¸…ç† ${module_path} ç¼“å­˜"
    fi
done

echo "â„¹ï¸  Go æ¨¡å—ç¼“å­˜æ¸…ç†å®Œæˆ"

# ä½¿ç”¨ 8 çº¿ç¨‹ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…åˆ° dl/ ç›®å½•
echo "[2/4] ä½¿ç”¨ 8 çº¿ç¨‹ä¸‹è½½ä¾èµ–åŒ…..."
make download -j8

# æ˜¾ç¤ºæ‰€æœ‰å°äº 1KB çš„æ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ä¸‹è½½å¤±è´¥çš„ç©ºæ–‡ä»¶ï¼‰
echo "[3/4] æ£€æŸ¥ä¸‹è½½å¤±è´¥çš„æ–‡ä»¶ï¼ˆå°äº 1KBï¼‰..."
find dl -size -1024c -exec ls -l {} \; 2>/dev/null || true

# åˆ é™¤æ‰€æœ‰å°äº 1KB çš„æ–‡ä»¶ï¼ˆæ¸…ç†ä¸‹è½½å¤±è´¥çš„æ®‹ç•™ï¼‰
echo "[4/4] æ¸…ç†ä¸‹è½½å¤±è´¥çš„æ®‹ç•™æ–‡ä»¶..."
find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true

echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆï¼"

