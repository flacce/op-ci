#!/bin/bash
#
# ============================================================================
# è„šæœ¬åç§°: 06-download-libs.sh
# åŠŸèƒ½æè¿°: ä¸‹è½½ç¼–è¯‘æ‰€éœ€çš„ä¾èµ–åŒ…
# ============================================================================
# ä½œç”¨:
#   1. ä½¿ç”¨å¤šçº¿ç¨‹ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…åˆ° dl/ ç›®å½•
#   2. æ˜¾ç¤ºä¸‹è½½å¤±è´¥çš„æ–‡ä»¶ï¼ˆå°äº 1KB çš„ç©ºæ–‡ä»¶ï¼‰
#   3. æ¸…ç†ä¸‹è½½å¤±è´¥çš„æ®‹ç•™æ–‡ä»¶
# ============================================================================
#

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "========================================="
echo "ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–..."
echo "========================================="

# è¿›å…¥ OpenWrt æºç ç›®å½•
cd openwrt

# æ¸…ç†æŸåçš„ Go æ¨¡å—ç¼“å­˜
echo "[1/4] æ¸…ç†æŸåçš„ Go æ¨¡å—ç¼“å­˜..."
if [ -d "dl/go-mod-cache/github.com/mdlayher/socket@v0.5.1" ]; then
    rm -rf dl/go-mod-cache/github.com/mdlayher/socket@v0.5.1
    echo "âœ… å·²æ¸…ç†æŸåçš„ mdlayher/socket@v0.5.1 ç¼“å­˜"
else
    echo "â„¹ï¸  æ— éœ€æ¸…ç†ï¼Œç¼“å­˜ç›®å½•ä¸å­˜åœ¨"
fi

# ä½¿ç”¨ 8 çº¿ç¨‹ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…åˆ° dl/ ç›®å½•
echo "[2/4] ä½¿ç”¨ 8 çº¿ç¨‹ä¸‹è½½ä¾èµ–åŒ…..."
make download -j8

# æ˜¾ç¤ºæ‰€æœ‰å°äº 1KB çš„æ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ä¸‹è½½å¤±è´¥çš„ç©ºæ–‡ä»¶ï¼‰
echo "[3/4] æ£€æŸ¥ä¸‹è½½å¤±è´¥çš„æ–‡ä»¶ï¼ˆå°äº 1KBï¼‰..."
find dl -size -1024c -exec ls -l {} \; 2>/dev/null || true

# åˆ é™¤æ‰€æœ‰å°äº 1KB çš„æ–‡ä»¶ï¼ˆæ¸…ç†ä¸‹è½½å¤±è´¥çš„æ®‹ç•™ï¼‰
echo "[4/4] æ¸…ç†ä¸‹è½½å¤±è´¥çš„æ®‹ç•™æ–‡ä»¶..."
find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true

echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆï¼"

