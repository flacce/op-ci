#
# ============================================================================
# LiBwrt å›ºä»¶è‡ªåŠ¨æ„å»º Workflow
# ============================================================================
# ç›®æ ‡è®¾å¤‡: äº¬ä¸œäº‘ äºšç‘Ÿ(RE-SS-01) å’Œ é›…å…¸å¨œ(RE-CS-02)
# æºç ä»“åº“: LiBwrt/openwrt-6.x (åŸç”Ÿæ”¯æŒä¸Šè¿°è®¾å¤‡)
# ============================================================================

name: ğŸš€ æ„å»º LiBwrt IPQ60xx å›ºä»¶

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH è¿œç¨‹è°ƒè¯•'
        type: boolean
        required: false
        default: false
  schedule:
    - cron: '0 20 * * *'  # åŒ—äº¬æ—¶é—´å‡Œæ™¨4ç‚¹ (UTC 20:00)

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x
  REPO_BRANCH: main-nss
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: seed.config
  TZ: Asia/Shanghai

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        chmod +x scripts/*.sh
        bash scripts/01-init-environment.sh

    - name: ğŸ“¦ å…‹éš†æœ€æ–°æºç 
      working-directory: /workdir
      run: |
        # ä½¿ç”¨ LiBwrt æºç 
        bash $GITHUB_WORKSPACE/scripts/02-clone-source.sh

    - name: ğŸ’¾ æ¢å¤ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: |
          /workdir/openwrt/dl
          /workdir/openwrt/.ccache
          /workdir/openwrt/staging_dir
        key: libwrt-cache-${{ hashFiles('seed.config') }}-${{ github.run_number }}
        restore-keys: |
          libwrt-cache-${{ hashFiles('seed.config') }}-
          libwrt-cache-

    - name: ğŸ”„ åˆ·æ–°ç¼“å­˜æ—¶é—´æˆ³
      working-directory: /workdir
      run: |
        if [ -d "openwrt/staging_dir" ]; then
          find openwrt/staging_dir -type d -name "stamp" -not -path "*target*" | while read -r dir; do
            find "$dir" -type f -exec touch {} +
          done
        fi

    - name: ğŸ“¦ å‡†å¤‡è½¯ä»¶åŒ…ç¯å¢ƒ
      run: |
        # æ³¨æ„ï¼šè¿™é‡Œç»§ç»­ä½¿ç”¨é€šç”¨çš„å‡†å¤‡è„šæœ¬
        # å¦‚æœ LiBwrt è‡ªå¸¦äº†æŸäº›æ’ä»¶ï¼Œè„šæœ¬ä¸­çš„å…‹éš†å¯èƒ½ä¼šè¢«è·³è¿‡æˆ–è¦†ç›–ï¼Œéœ€æ³¨æ„æ£€æŸ¥
        bash scripts/03-prepare-packages.sh

    - name: ğŸ§¹ æ¸…ç†å†²çªæ’ä»¶
      run: bash scripts/04-clean-conflicts.sh

    - name: ğŸ“¥ å®‰è£… Feeds
      run: bash scripts/install-feeds.sh

    - name: âš™ï¸ åŠ è½½é…ç½®æ–‡ä»¶
      run: bash scripts/05-load-config.sh

    - name: ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–
      run: bash scripts/06-download-libs.sh

    - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        bash scripts/07-compile.sh
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ğŸ”Œ SSH è¿œç¨‹è°ƒè¯• (ç¼–è¯‘å®Œæˆå)
      if: github.event.inputs.ssh == true
      uses: mxschmitt/action-tmate@v3
      timeout-minutes: 60
      with:
        limit-access-to-actor: true

    - name: ğŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        output=$(bash scripts/08-organize-files.sh)
        echo "$output"
        FIRMWARE_DIR=$(echo "$output" | grep "FIRMWARE_DIR=" | cut -d'=' -f2)
        echo "FIRMWARE=$FIRMWARE_DIR" >> $GITHUB_ENV
        BUILD_DATE=$(TZ=Asia/Shanghai date '+%Y-%m-%d')
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name:  ä¸Šä¼ å›ºä»¶åˆ° Artifacts
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: LiBwrt_å›ºä»¶_${{ steps.organize.outputs.BUILD_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ğŸš€ å‘å¸ƒåˆ° GitHub Releases
      uses: softprops/action-gh-release@v1
      if: steps.organize.outputs.status == 'success'
      with:
        tag_name: libwrt-${{ steps.organize.outputs.BUILD_DATE }}
        name: LiBwrt IPQ60xx å›ºä»¶ ${{ steps.organize.outputs.BUILD_DATE }}
        body: |
          ## ğŸ“¦ LiBwrt å›ºä»¶å‘å¸ƒ
          
          ### ğŸ¯ ç›®æ ‡è®¾å¤‡
          - äº¬ä¸œäº‘ äºšç‘Ÿï¼ˆRE-SS-01ï¼‰
          - äº¬ä¸œäº‘ é›…å…¸å¨œï¼ˆRE-CS-02ï¼‰
          
          ### â„¹ï¸ è¯´æ˜
          - æºç æ¥æº: [LiBwrt/openwrt-6.x](https://github.com/LiBwrt/openwrt-6.x)
          - å†…æ ¸ç‰ˆæœ¬: 6.6
          
          ### ğŸ“Š æ„å»ºä¿¡æ¯
          - ğŸ• æ„å»ºæ—¶é—´ï¼š${{ steps.organize.outputs.BUILD_DATE }}
        files: ${{ env.FIRMWARE }}/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    if: always()
    needs: build
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 3

