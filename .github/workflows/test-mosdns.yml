#
# ============================================================================
# æµ‹è¯• mosdns å•ç‹¬æž„å»º
# ç›®çš„: æµ‹è¯• mdlayher/socket åŒ…ç¼“å­˜é—®é¢˜æ˜¯å¦ä¿®å¤
# ============================================================================

name: ðŸ”§ æµ‹è¯• mosdns å•ç‹¬æž„å»º

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: seed.config
  TZ: Asia/Shanghai

jobs:
  build-mosdns:
    runs-on: ubuntu-24.04

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ”§ åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        chmod +x scripts/*.sh
        bash scripts/01-init-environment.sh

    - name: ðŸ“¦ å…‹éš†æœ€æ–°æºç 
      working-directory: /workdir
      run: bash $GITHUB_WORKSPACE/scripts/02-clone-source.sh

    - name: ðŸ’¾ æ¢å¤ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: |
          /workdir/openwrt/dl
          /workdir/openwrt/.ccache
          /workdir/openwrt/staging_dir
        key: test-mosdns-cache-${{ hashFiles('seed.config') }}-${{ github.run_number }}
        restore-keys: |
          test-mosdns-cache-${{ hashFiles('seed.config') }}-
          test-mosdns-cache-

    - name: ðŸ”„ åˆ·æ–°ç¼“å­˜æ—¶é—´æˆ³
      working-directory: /workdir
      run: |
        if [ -d "openwrt/staging_dir" ]; then
          find openwrt/staging_dir -type d -name "stamp" -not -path "*target*" | while read -r dir; do
            find "$dir" -type f -exec touch {} +
          done
        fi

    - name: ðŸ“¦ å‡†å¤‡è½¯ä»¶åŒ…çŽ¯å¢ƒ
      run: bash scripts/03-prepare-packages.sh

    - name: ðŸ§¹ æ¸…ç†å†²çªæ’ä»¶
      run: bash scripts/04-clean-conflicts.sh

    - name: ðŸ“¥ å®‰è£… Feeds
      run: bash scripts/install-feeds.sh

    - name: âš™ï¸ åŠ è½½é…ç½®æ–‡ä»¶
      run: bash scripts/05-load-config.sh

    - name: ðŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–
      run: bash scripts/06-download-libs.sh

    - name: ðŸ”¨ å•ç‹¬ç¼–è¯‘ mosdns
      id: compile
      working-directory: /workdir/openwrt
      run: |
        make package/custom/luci-app-mosdns/mosdns/compile V=s 2>&1 | tee /tmp/mosdns-build.log
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "âŒ æž„å»ºå¤±è´¥"
          exit 1
        fi

    - name: ðŸ“‹ æž„å»ºæ—¥å¿—
      if: always()
      run: |
        echo "### æž„å»ºæ—¥å¿—" >> $GITHUB_STEP_SUMMARY
        tail -100 /tmp/mosdns-build.log >> $GITHUB_STEP_SUMMARY
