#
# ============================================================================
# ImmortalWrt å›ºä»¶è‡ªåŠ¨æž„å»º Workflow
# ============================================================================
# ä½œè€…: azxf
# ç”Ÿæˆ: Gemini AI
# ç›®æ ‡è®¾å¤‡: äº¬ä¸œäº‘ RE-CS-02 (IPQ60xx)
# æ ¸å¿ƒç‰¹æ€§: APK åŒ…ç®¡ç†å™¨ + HomeProxy + Lucky + AdGuardHome + æµé‡ç›‘æŽ§
#
# è®¾è®¡ç†å¿µ:
#   - æ‰€æœ‰æ‰§è¡Œå‘½ä»¤éƒ½æå–åˆ°ç‹¬ç«‹è„šæœ¬æ–‡ä»¶ä¸­ï¼ˆscripts/ç›®å½•ï¼‰
#   - è„šæœ¬å¯åœ¨æœ¬åœ°å’Œ CI çŽ¯å¢ƒä¸­å¤ç”¨
#   - Workflow åªè´Ÿè´£æµç¨‹ç¼–æŽ’å’ŒçŽ¯å¢ƒç®¡ç†
#   - æ¯æ¬¡æž„å»ºéƒ½æ‹‰å–æœ€æ–°çš„æºç å’Œæ’ä»¶
# ============================================================================
#

name: ðŸš€ æž„å»º ImmortalWrt IPQ60xx å›ºä»¶

# ============================================================================
# è§¦å‘æ¡ä»¶
# ============================================================================
# workflow_dispatch: æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ Actions é¡µé¢ç‚¹å‡» "Run workflow"ï¼‰
# ============================================================================
on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH è¿œç¨‹è°ƒè¯•'  # SSH è¿žæŽ¥åˆ° Actions è™šæ‹Ÿæœºï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
        required: false
        default: 'false'

# ============================================================================
# å…¨å±€çŽ¯å¢ƒå˜é‡
# ============================================================================
# è¿™äº›çŽ¯å¢ƒå˜é‡ä¼šè¢«è„šæœ¬å¼•ç”¨
# ============================================================================
env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt  # ImmortalWrt å®˜æ–¹ä»“åº“
  REPO_BRANCH: master                                   # ä¸»çº¿åˆ†æ”¯
  FEEDS_CONF: feeds.conf.default                        # Feeds é…ç½®æ–‡ä»¶
  CONFIG_FILE: seed.config                              # æœ¬åœ°é…ç½®æ–‡ä»¶å
  TZ: Asia/Shanghai                                     # æ—¶åŒºï¼ˆç”¨äºŽæ—¥å¿—æ—¶é—´æˆ³ï¼‰

# ============================================================================
# æž„å»ºä»»åŠ¡
# ============================================================================
jobs:
  build:
    # ------------------------------------------------------------------------
    # è¿è¡ŒçŽ¯å¢ƒ: Ubuntu 24.04 LTSï¼ˆæœ€æ–°ç¨³å®šç‰ˆï¼‰
    # ä½¿ç”¨ matrix strategy ä»¥ä¾¿å°†æ¥æ‰©å±•å¤šç³»ç»Ÿæ”¯æŒ
    # ------------------------------------------------------------------------
    strategy:
      matrix:
        os: [ubuntu-24.04]
    
    runs-on: ${{ matrix.os }}

    steps:
    # ------------------------------------------------------------------------
    # æ­¥éª¤ 1: ðŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
    # ------------------------------------------------------------------------
    # æ‹‰å–å½“å‰ä»“åº“çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬ seed.config å’Œ scripts/*.shï¼‰
    # ------------------------------------------------------------------------
    - name: ðŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v3

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 2: ðŸ”§ åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/01-init-environment.sh
    # åŠŸèƒ½:
    #   - ä½¿ç”¨ ImmortalWrt å®˜æ–¹åˆå§‹åŒ–è„šæœ¬
    #   - è‡ªåŠ¨å®‰è£…æ‰€æœ‰ç¼–è¯‘ä¾èµ–
    #   - è®¾ç½®æ—¶åŒºä¸º Asia/Shanghai
    #   - åˆ›å»ºå·¥ä½œç›®å½• /workdir
    # ------------------------------------------------------------------------
    - name: ðŸ”§ åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive  # éžäº¤äº’æ¨¡å¼ï¼Œé¿å… apt å¼¹çª—
      run: |
        chmod +x scripts/*.sh
        bash scripts/01-init-environment.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 3: ðŸ“¦ å…‹éš†æœ€æ–°æºç 
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/02-clone-source.sh
    # åŠŸèƒ½:
    #   - å…‹éš† ImmortalWrt ä¸»çº¿æœ€æ–°æºç ï¼ˆæµ…å…‹éš†ï¼ŒèŠ‚çœæ—¶é—´ï¼‰
    #   - åˆ›å»ºè½¯é“¾æŽ¥åˆ° $GITHUB_WORKSPACE/openwrt
    # çŽ¯å¢ƒå˜é‡:
    #   - REPO_URL: ImmortalWrt ä»“åº“åœ°å€
    #   - REPO_BRANCH: åˆ†æ”¯åç§°ï¼ˆmasterï¼‰
    # æ³¨æ„:
    #   - ä½¿ç”¨ --depth=1 ç¡®ä¿æ¯æ¬¡éƒ½æ‹‰å–æœ€æ–°ä»£ç 
    # ------------------------------------------------------------------------
    - name: ðŸ“¦ å…‹éš†æœ€æ–°æºç 
      working-directory: /workdir
      run: bash $GITHUB_WORKSPACE/scripts/02-clone-source.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 4: ðŸ”„ æ›´æ–° Feeds åˆ°æœ€æ–°ç‰ˆæœ¬
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/03-update-feeds.sh
    # åŠŸèƒ½:
    #   - æ›´æ–°æ‰€æœ‰ feeds æºåˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆpackagesã€luciã€routing ç­‰ï¼‰
    #   - å®‰è£…æ‰€æœ‰ feeds è½¯ä»¶åŒ…åˆ° staging_dir
    # æ³¨æ„:
    #   - æ¯æ¬¡éƒ½ä¼šæ‹‰å–æœ€æ–°çš„ feeds æ’ä»¶ä»£ç 
    # ------------------------------------------------------------------------
    - name: ðŸ”„ æ›´æ–° Feeds åˆ°æœ€æ–°ç‰ˆæœ¬
      run: bash scripts/03-update-feeds.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 5: ðŸ§¹ æ¸…ç†å†²çªæ’ä»¶
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/04-clean-conflicts.sh
    # åŠŸèƒ½:
    #   åˆ é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´ç¼–è¯‘å†²çªçš„æ’ä»¶ï¼ŒåŒ…æ‹¬:
    #   - VPN/ä»£ç†ç±»: SSR Plusã€Bypassã€VSSRã€FcHomo ç­‰
    #   - å¤šæ‹¨/è´Ÿè½½å‡è¡¡ç±»: Mwan3ã€MultiAccount Dial ç­‰
    #   - iStore/Docker/QoS ç±»: iStoreã€SQMã€Natflow ç­‰
    #   - DNS è§£æžç±»: SmartDNSã€MosDNSã€v2ray-geodata
    #   - å…¶ä»–é—®é¢˜ä¾èµ–: GNUnetã€OnionShare CLI ç­‰
    # ------------------------------------------------------------------------
    - name: ðŸ§¹ æ¸…ç†å†²çªæ’ä»¶
      run: bash scripts/04-clean-conflicts.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 6: âš™ï¸ åŠ è½½é…ç½®æ–‡ä»¶
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/05-load-config.sh
    # åŠŸèƒ½:
    #   - åŠ è½½ seed.config é…ç½®æ–‡ä»¶
    #   - å¼ºåˆ¶å¯ç”¨ APK åŒ…ç®¡ç†å™¨ï¼ˆæ–°ä¸€ä»£åŒ…ç®¡ç†ï¼‰
    #   - ç¦ç”¨æ—§çš„ OPKG åŒ…ç®¡ç†å™¨
    #   - å¼ºåˆ¶å¯ç”¨æ ¸å¿ƒæ’ä»¶ï¼ˆåŒé‡ä¿é™©ï¼‰:
    #     * HomeProxyï¼ˆä»£ç†ç®¡ç†ï¼‰
    #     * Luckyï¼ˆç»¼åˆå·¥å…·ç®±ï¼‰
    #     * nlbwmonï¼ˆæµé‡ç›‘æŽ§ï¼‰
    #     * wrtbwmonï¼ˆå¸¦å®½ç›‘æŽ§ï¼‰
    #     * AdGuardHomeï¼ˆå¹¿å‘Šæ‹¦æˆªï¼‰
    #   - è¿è¡Œ make defconfig è‡ªåŠ¨è¡¥å…¨ä¾èµ–
    # çŽ¯å¢ƒå˜é‡:
    #   - CONFIG_FILE: é…ç½®æ–‡ä»¶åï¼ˆseed.configï¼‰
    # ------------------------------------------------------------------------
    - name: âš™ï¸ åŠ è½½é…ç½®æ–‡ä»¶
      run: bash scripts/05-load-config.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 7: ðŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/06-download-libs.sh
    # åŠŸèƒ½:
    #   - ä½¿ç”¨ 8 çº¿ç¨‹ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…åˆ° dl/ ç›®å½•
    #   - æ£€æŸ¥ä¸‹è½½å¤±è´¥çš„æ–‡ä»¶ï¼ˆå°äºŽ 1KBï¼‰
    #   - æ¸…ç†ä¸‹è½½å¤±è´¥çš„æ®‹ç•™æ–‡ä»¶
    # ------------------------------------------------------------------------
    - name: ðŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–
      run: bash scripts/06-download-libs.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 8: ðŸ”¨ ç¼–è¯‘å›ºä»¶
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/07-compile.sh
    # åŠŸèƒ½:
    #   - å°è¯•ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒå¹¶è¡Œç¼–è¯‘ï¼ˆé€Ÿåº¦å¿«ï¼‰
    #   - å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å•æ ¸è¯¦ç»†æ¨¡å¼ï¼ˆV=sï¼Œä¾¿äºŽæŽ’é”™ï¼‰
    # è¾“å‡º:
    #   - status=successï¼ˆç¼–è¯‘æˆåŠŸæ ‡è®°ï¼Œä¾›åŽç»­æ­¥éª¤åˆ¤æ–­ï¼‰
    # ------------------------------------------------------------------------
    - name: ðŸ”¨ ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        bash scripts/07-compile.sh
        echo "status=success" >> $GITHUB_OUTPUT

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 9: ðŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/08-organize-files.sh
    # åŠŸèƒ½:
    #   - è¿›å…¥å›ºä»¶è¾“å‡ºç›®å½•ï¼ˆbin/targets/*/*ï¼‰
    #   - åˆ é™¤ packages ç›®å½•ï¼ˆèŠ‚çœç©ºé—´ï¼‰
    #   - è¾“å‡ºå›ºä»¶æ–‡ä»¶åˆ—è¡¨
    # è¾“å‡º:
    #   - FIRMWARE_DIR: å›ºä»¶ç›®å½•è·¯å¾„ï¼ˆç”¨äºŽä¸Šä¼ ï¼‰
    # æ¡ä»¶:
    #   - ä»…åœ¨ç¼–è¯‘æˆåŠŸæ—¶æ‰§è¡Œ
    # ------------------------------------------------------------------------
    - name: ðŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success'  # ä»…åœ¨ç¼–è¯‘æˆåŠŸæ—¶æ‰§è¡Œ
      run: |
        output=$(bash scripts/08-organize-files.sh)
        echo "$output"
        # æå– FIRMWARE_DIR çŽ¯å¢ƒå˜é‡
        FIRMWARE_DIR=$(echo "$output" | grep "FIRMWARE_DIR=" | cut -d'=' -f2)
        echo "FIRMWARE=$FIRMWARE_DIR" >> $GITHUB_ENV
        # ç”Ÿæˆæ—¥æœŸæ ‡è¯†ï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
        BUILD_DATE=$(TZ=Asia/Shanghai date '+%Y-%m-%d')
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 10: ðŸš€ ä¸Šä¼ å›ºä»¶
    # ------------------------------------------------------------------------
    # ä½¿ç”¨ GitHub Actions å®˜æ–¹ä¸Šä¼ åŠ¨ä½œ
    # åŠŸèƒ½:
    #   - å°†ç¼–è¯‘å¥½çš„å›ºä»¶ä¸Šä¼ åˆ° GitHub Artifacts
    #   - ä¿ç•™æ—¶é—´: 90 å¤©ï¼ˆé»˜è®¤ï¼‰
    #   - ä¸‹è½½ä½ç½®: Actions é¡µé¢ â†’ å¯¹åº”çš„ workflow run â†’ Artifacts
    # å‘½åæ ¼å¼:
    #   - OpenWrt_å›ºä»¶_YYYY-MM-DDï¼ˆæŒ‰æ—¥æœŸå‘½åï¼Œæ–¹ä¾¿è¯†åˆ«ï¼‰
    # æ¡ä»¶:
    #   - ä»…åœ¨å›ºä»¶æ•´ç†æˆåŠŸæ—¶æ‰§è¡Œ
    # ------------------------------------------------------------------------
    - name: ðŸš€ ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v3
      if: steps.organize.outputs.status == 'success'  # ä»…åœ¨æ•´ç†æˆåŠŸæ—¶æ‰§è¡Œ
      with:
        name: OpenWrt_å›ºä»¶_${{ steps.organize.outputs.BUILD_DATE }}  # æŒ‰æ—¥æœŸå‘½å
        path: ${{ env.FIRMWARE }}                                    # å›ºä»¶ç›®å½•è·¯å¾„

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 11: ðŸ“‹ ç”Ÿæˆæž„å»ºæ‘˜è¦
    # ------------------------------------------------------------------------
    # è¾“å‡ºæž„å»ºæ‘˜è¦ä¿¡æ¯åˆ° GitHub Actions Summaryï¼Œæ–¹ä¾¿æŸ¥çœ‹
    # ------------------------------------------------------------------------
    - name: ðŸ“‹ ç”Ÿæˆæž„å»ºæ‘˜è¦
      if: steps.compile.outputs.status == 'success'
      run: |
        echo "## ðŸŽ‰ å›ºä»¶æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ• æž„å»ºæ—¶é—´: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ·ï¸ æž„å»ºç¼–å·: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ³ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ–¥ï¸ è¿è¡ŒçŽ¯å¢ƒ: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ’¾ å›ºä»¶è·¯å¾„: \`${{ env.FIRMWARE }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ å›ºä»¶åç§°: OpenWrt_å›ºä»¶_${{ steps.organize.outputs.BUILD_DATE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½å›ºä»¶" >> $GITHUB_STEP_SUMMARY
        echo "åœ¨å½“å‰é¡µé¢çš„ **Artifacts** åŒºåŸŸä¸‹è½½ç¼–è¯‘å¥½çš„å›ºä»¶" >> $GITHUB_STEP_SUMMARY