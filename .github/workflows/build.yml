#
# ============================================================================
# ImmortalWrt å›ºä»¶è‡ªåŠ¨æ„å»º Workflow
# ============================================================================
# ä½œè€…: azxf
# ç”Ÿæˆ: Gemini AI
# ç›®æ ‡è®¾å¤‡: äº¬ä¸œäº‘ äºšç‘Ÿå’Œé›…å…¸å¨œ (IPQ60xx)
# æ ¸å¿ƒç‰¹æ€§: APK åŒ…ç®¡ç†å™¨ + HomeProxy + Lucky + AdGuardHome + æµé‡ç›‘æ§
#
# è®¾è®¡ç†å¿µ:
#   - æ‰€æœ‰æ‰§è¡Œå‘½ä»¤éƒ½æå–åˆ°ç‹¬ç«‹è„šæœ¬æ–‡ä»¶ä¸­ï¼ˆscripts/ç›®å½•ï¼‰
#   - è„šæœ¬å¯åœ¨æœ¬åœ°å’Œ CI ç¯å¢ƒä¸­å¤ç”¨
#   - Workflow åªè´Ÿè´£æµç¨‹ç¼–æ’å’Œç¯å¢ƒç®¡ç†
#   - æ¯æ¬¡æ„å»ºéƒ½æ‹‰å–æœ€æ–°çš„æºç å’Œæ’ä»¶
# ============================================================================
#

name: ğŸš€ æ„å»º ImmortalWrt IPQ60xx å›ºä»¶

# ============================================================================
# è§¦å‘æ¡ä»¶
# ============================================================================
# workflow_dispatch: æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ Actions é¡µé¢ç‚¹å‡» "Run workflow"ï¼‰
# ============================================================================
on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH è¿œç¨‹è°ƒè¯•'  # SSH è¿æ¥åˆ° Actions è™šæ‹Ÿæœºï¼ˆç”¨äºè°ƒè¯•ï¼‰
        type: boolean
        required: false
        default: false
  schedule:
    - cron: '0 20 * * *'  # åŒ—äº¬æ—¶é—´å‡Œæ™¨4ç‚¹ (UTC 20:00)

# ============================================================================
# å…¨å±€ç¯å¢ƒå˜é‡
# ============================================================================
# è¿™äº›ç¯å¢ƒå˜é‡ä¼šè¢«è„šæœ¬å¼•ç”¨
# ============================================================================
env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt  # ImmortalWrt å®˜æ–¹ä»“åº“
  REPO_BRANCH: master                                   # ä¸»çº¿åˆ†æ”¯
  FEEDS_CONF: feeds.conf.default                        # Feeds é…ç½®æ–‡ä»¶
  CONFIG_FILE: seed.config                              # æœ¬åœ°é…ç½®æ–‡ä»¶å
  TZ: Asia/Shanghai                                     # æ—¶åŒºï¼ˆç”¨äºæ—¥å¿—æ—¶é—´æˆ³ï¼‰

# ============================================================================
# æƒé™é…ç½®
# ============================================================================
# å…è®¸ workflow åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
# ============================================================================
permissions:
  contents: write  # å…è®¸åˆ›å»º Releaseã€ä¸Šä¼ æ–‡ä»¶

# ============================================================================
# æ„å»ºä»»åŠ¡
# ============================================================================
jobs:
  build:
    # ------------------------------------------------------------------------
    # è¿è¡Œç¯å¢ƒ: Ubuntu 24.04 LTSï¼ˆæœ€æ–°ç¨³å®šç‰ˆï¼‰
    # ä½¿ç”¨ matrix strategy ä»¥ä¾¿å°†æ¥æ‰©å±•å¤šç³»ç»Ÿæ”¯æŒ
    # ------------------------------------------------------------------------
    strategy:
      matrix:
        os: [ubuntu-24.04]
    
    runs-on: ${{ matrix.os }}

    steps:
    # ------------------------------------------------------------------------
    # æ­¥éª¤ 1: ğŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
    # ------------------------------------------------------------------------
    # æ‹‰å–å½“å‰ä»“åº“çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬ seed.config å’Œ scripts/*.shï¼‰
    # ------------------------------------------------------------------------
    - name: ğŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 2: ğŸ”§ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/01-init-environment.sh
    # åŠŸèƒ½:
    #   - ä½¿ç”¨ ImmortalWrt å®˜æ–¹åˆå§‹åŒ–è„šæœ¬
    #   - è‡ªåŠ¨å®‰è£…æ‰€æœ‰ç¼–è¯‘ä¾èµ–
    #   - è®¾ç½®æ—¶åŒºä¸º Asia/Shanghai
    #   - åˆ›å»ºå·¥ä½œç›®å½• /workdir
    # ------------------------------------------------------------------------
    - name: ğŸ”§ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive  # éäº¤äº’æ¨¡å¼ï¼Œé¿å… apt å¼¹çª—
      run: |
        chmod +x scripts/*.sh
        bash scripts/01-init-environment.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 3: ğŸ“¦ å…‹éš†æœ€æ–°æºç 
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/02-clone-source.sh
    # åŠŸèƒ½:
    #   - å…‹éš† ImmortalWrt ä¸»çº¿æœ€æ–°æºç ï¼ˆæµ…å…‹éš†ï¼ŒèŠ‚çœæ—¶é—´ï¼‰
    #   - åˆ›å»ºè½¯é“¾æ¥åˆ° $GITHUB_WORKSPACE/openwrt
    # ç¯å¢ƒå˜é‡:
    #   - REPO_URL: ImmortalWrt ä»“åº“åœ°å€
    #   - REPO_BRANCH: åˆ†æ”¯åç§°ï¼ˆmasterï¼‰
    # æ³¨æ„:
    #   - ä½¿ç”¨ --depth=1 ç¡®ä¿æ¯æ¬¡éƒ½æ‹‰å–æœ€æ–°ä»£ç 
    # ------------------------------------------------------------------------
    - name: ğŸ“¦ å…‹éš†æœ€æ–°æºç 
      working-directory: /workdir
      run: bash $GITHUB_WORKSPACE/scripts/02-clone-source.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 3.5: ğŸ’¾ æ¢å¤ç¼“å­˜
    # ------------------------------------------------------------------------
    # ä½¿ç”¨ GitHub Actions ç¼“å­˜æœºåˆ¶
    # ç¼“å­˜å†…å®¹:
    #   - dl/ ç›®å½•ï¼šå·²ä¸‹è½½çš„æºç åŒ…ï¼ˆæœ€é‡è¦ï¼Œå¯èŠ‚çœå¤§é‡ä¸‹è½½æ—¶é—´ï¼‰
    #   - .ccache/ ç›®å½•ï¼šç¼–è¯‘ç¼“å­˜ï¼ˆåŠ é€Ÿé‡å¤ç¼–è¯‘ï¼‰
    #   - staging_dir/ ç›®å½•ï¼šå·¥å…·é“¾ç¼“å­˜ï¼ˆè·³è¿‡å·¥å…·é“¾ç¼–è¯‘ï¼‰
    # ç¼“å­˜é”®:
    #   - åŸºäºé…ç½®æ–‡ä»¶å“ˆå¸Œå’Œæ„å»ºç¼–å·
    #   - æ»šåŠ¨ç¼“å­˜ï¼Œè‡ªåŠ¨ä½¿ç”¨æœ€è¿‘çš„ç¼“å­˜
    # ------------------------------------------------------------------------
    - name: ğŸ§¹ æ¸…ç†æŸåçš„ Go æ¨¡å—ç¼“å­˜
      run: |
        rm -rf /workdir/openwrt/dl/go-mod-cache/github.com/mdlayher/socket@v0.5.1 2>/dev/null || true
        echo "âœ… å·²æ¸…ç†æŸåçš„ mdlayher/socket ç¼“å­˜"

    - name: ğŸ’¾ æ¢å¤ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: |
          /workdir/openwrt/dl
          /workdir/openwrt/.ccache
          /workdir/openwrt/staging_dir
        key: openwrt-cache-${{ hashFiles('seed.config') }}-${{ github.run_number }}
        restore-keys: |
          openwrt-cache-${{ hashFiles('seed.config') }}-
          openwrt-cache-

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 3.6: ğŸ”„ åˆ·æ–°ç¼“å­˜æ—¶é—´æˆ³
    # ------------------------------------------------------------------------
    # åˆ·æ–° staging_dir ä¸­çš„ stamp æ–‡ä»¶
    # ä½œç”¨:
    #   - é˜²æ­¢ make è®¤ä¸ºç¼“å­˜çš„æ–‡ä»¶è¿‡æ—¶
    #   - ç¡®ä¿ç¼“å­˜çš„å·¥å…·é“¾å¯ä»¥æ­£å¸¸ä½¿ç”¨
    # ------------------------------------------------------------------------
    - name: ğŸ”„ åˆ·æ–°ç¼“å­˜æ—¶é—´æˆ³
      working-directory: /workdir
      run: |
        if [ -d "openwrt/staging_dir" ]; then
          echo "åˆ·æ–° staging_dir æ—¶é—´æˆ³..."
          find openwrt/staging_dir -type d -name "stamp" -not -path "*target*" | while read -r dir; do
            find "$dir" -type f -exec touch {} +
          done
          echo "âœ… æ—¶é—´æˆ³åˆ·æ–°å®Œæˆ"
        else
          echo "staging_dir ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°"
        fi

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 4: ğŸ“¦ å‡†å¤‡è½¯ä»¶åŒ…ç¯å¢ƒ (Feeds & Custom Plugins)
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/03-prepare-packages.sh
    # åŠŸèƒ½:
    #   1. æ›´æ–° Feeds åˆ°æœ€æ–°ç‰ˆæœ¬
    #   2. å…‹éš†ç¬¬ä¸‰æ–¹æ’ä»¶ (Lucky, HomeProxy, sing-box ç­‰)
    #   3. ä¿®å¤é€šè¿‡ sparse-checkout è·å–çš„ sing-box åŒ…å®šä¹‰
    #   4. ä¿®å¤ homeproxy å’Œ sing-box çš„ Makefile å¾ªç¯ä¾èµ–
    # ------------------------------------------------------------------------
    - name: ğŸ“¦ å‡†å¤‡è½¯ä»¶åŒ…ç¯å¢ƒ
      run: bash scripts/03-prepare-packages.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 4.5: ğŸ”§ æ·»åŠ è‡ªå®šä¹‰è®¾å¤‡æ”¯æŒ (RE-CS-02/RE-SS-01)
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/09-add-custom-devices.sh
    # åŠŸèƒ½:
    #   - ä» LEDE ä»“åº“ä¸‹è½½ DTS æ–‡ä»¶
    #   - ä¿®æ”¹ Makefile æ·»åŠ è®¾å¤‡å®šä¹‰
    #   - è§£å†³ ImmortalWrt å®˜æ–¹æºç ä¸æ”¯æŒè¿™äº›è®¾å¤‡çš„é—®é¢˜
    # ------------------------------------------------------------------------
    - name: ğŸ”§ æ·»åŠ è‡ªå®šä¹‰è®¾å¤‡æ”¯æŒ
      run: bash scripts/09-add-custom-devices.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 5: ğŸ§¹ æ¸…ç†å†²çªæ’ä»¶
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/04-clean-conflicts.sh
    # åŠŸèƒ½:
    #   åˆ é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´ç¼–è¯‘å†²çªçš„æ’ä»¶ï¼ŒåŒ…æ‹¬:
    #   - å†²çªçš„ sing-box å’Œ homeproxy ç‰ˆæœ¬
    #   - ä¸éœ€è¦çš„å¤šä½™æ’ä»¶ (AdGuardHome feeds ç‰ˆç­‰)
    # ------------------------------------------------------------------------
    - name: ğŸ§¹ æ¸…ç†å†²çªæ’ä»¶
      run: bash scripts/04-clean-conflicts.sh

    # ------------------------------------------------------------------------
    # ------------------------------------------------------------------------
    # æ­¥éª¤ 6: ğŸ“¥ å®‰è£… Feeds
    # ------------------------------------------------------------------------
    # æ³¨æ„: éœ€è¦åœ¨æ¸…ç†å†²çªåå®‰è£…ï¼Œç¡®ä¿è½¯é“¾æ¥æ­£ç¡®æŒ‡å‘
    # ------------------------------------------------------------------------
    - name: ğŸ“¥ å®‰è£… Feeds
      run: bash scripts/install-feeds.sh


    # ------------------------------------------------------------------------
    # æ­¥éª¤ 6: âš™ï¸ åŠ è½½é…ç½®æ–‡ä»¶
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/05-load-config.sh
    # åŠŸèƒ½:
    #   - åŠ è½½ seed.config é…ç½®æ–‡ä»¶
    #   - å¼ºåˆ¶å¯ç”¨ APK åŒ…ç®¡ç†å™¨ï¼ˆæ–°ä¸€ä»£åŒ…ç®¡ç†ï¼‰
    #   - ç¦ç”¨æ—§çš„ OPKG åŒ…ç®¡ç†å™¨
    #   - å¼ºåˆ¶å¯ç”¨æ ¸å¿ƒæ’ä»¶ï¼ˆåŒé‡ä¿é™©ï¼‰:
    #     * HomeProxyï¼ˆä»£ç†ç®¡ç†ï¼‰
    #     * Luckyï¼ˆç»¼åˆå·¥å…·ç®±ï¼‰
    #     * nlbwmonï¼ˆæµé‡ç›‘æ§ï¼‰
    #     * wrtbwmonï¼ˆå¸¦å®½ç›‘æ§ï¼‰
    #     * AdGuardHomeï¼ˆå¹¿å‘Šæ‹¦æˆªï¼‰
    #   - è¿è¡Œ make defconfig è‡ªåŠ¨è¡¥å…¨ä¾èµ–
    # ç¯å¢ƒå˜é‡:
    #   - CONFIG_FILE: é…ç½®æ–‡ä»¶åï¼ˆseed.configï¼‰
    # ------------------------------------------------------------------------
    - name: âš™ï¸ åŠ è½½é…ç½®æ–‡ä»¶
      run: bash scripts/05-load-config.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 7: ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/06-download-libs.sh
    # åŠŸèƒ½:
    #   - ä½¿ç”¨ 8 çº¿ç¨‹ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…åˆ° dl/ ç›®å½•
    #   - æ£€æŸ¥ä¸‹è½½å¤±è´¥çš„æ–‡ä»¶ï¼ˆå°äº 1KBï¼‰
    #   - æ¸…ç†ä¸‹è½½å¤±è´¥çš„æ®‹ç•™æ–‡ä»¶
    # ------------------------------------------------------------------------
    - name: ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–
      run: bash scripts/06-download-libs.sh

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 8: ğŸ”¨ ç¼–è¯‘å›ºä»¶
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/07-compile.sh
    # åŠŸèƒ½:
    #   - å°è¯•ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒå¹¶è¡Œç¼–è¯‘ï¼ˆé€Ÿåº¦å¿«ï¼‰
    #   - å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å•æ ¸è¯¦ç»†æ¨¡å¼ï¼ˆV=sï¼Œä¾¿äºæ’é”™ï¼‰
    # è¾“å‡º:
    #   - status=successï¼ˆç¼–è¯‘æˆåŠŸæ ‡è®°ï¼Œä¾›åç»­æ­¥éª¤åˆ¤æ–­ï¼‰
    # ------------------------------------------------------------------------
    - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        bash scripts/07-compile.sh
        echo "status=success" >> $GITHUB_OUTPUT

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 8.5: ğŸ”Œ SSH è¿œç¨‹è°ƒè¯• (tmate)
    # ------------------------------------------------------------------------
    # å½“å‹¾é€‰ SSH è°ƒè¯•æ—¶ï¼Œåœ¨ç¼–è¯‘å®Œæˆåå¯åŠ¨ SSH ä¼šè¯
    # ç”¨é€”:
    #   - æ£€æŸ¥ç¼–è¯‘ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶
    #   - æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—å’Œè¾“å‡º
    #   - è°ƒè¯•å›ºä»¶å†…å®¹
    # ä½¿ç”¨æ–¹æ³•:
    #   1. Run workflow æ—¶å‹¾é€‰ "SSH è¿œç¨‹è°ƒè¯•"
    #   2. workflow ä¼šåœ¨æ­¤å¤„æš‚åœå¹¶æ˜¾ç¤º SSH è¿æ¥å‘½ä»¤
    #   3. è¿æ¥åå¯ä»¥æŸ¥çœ‹: /workdir/openwrt/bin/targets/
    #   4. è°ƒè¯•å®Œæˆååœ¨ç»ˆç«¯è¾“å…¥: touch /tmp/continue
    # è¶…æ—¶: 60 åˆ†é’Ÿ
    # ------------------------------------------------------------------------
    - name: ğŸ”Œ SSH è¿œç¨‹è°ƒè¯• (ç¼–è¯‘å®Œæˆå)
      if: github.event.inputs.ssh == 'true'
      uses: mxschmitt/action-tmate@v3
      timeout-minutes: 60
      with:
        limit-access-to-actor: true

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 9: ğŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶
    # ------------------------------------------------------------------------
    # æ‰§è¡Œè„šæœ¬: scripts/08-organize-files.sh
    # åŠŸèƒ½:
    #   - è¿›å…¥å›ºä»¶è¾“å‡ºç›®å½•ï¼ˆbin/targets/*/*ï¼‰
    #   - åˆ é™¤ packages ç›®å½•ï¼ˆèŠ‚çœç©ºé—´ï¼‰
    #   - è¾“å‡ºå›ºä»¶æ–‡ä»¶åˆ—è¡¨
    # è¾“å‡º:
    #   - FIRMWARE_DIR: å›ºä»¶ç›®å½•è·¯å¾„ï¼ˆç”¨äºä¸Šä¼ ï¼‰
    # æ¡ä»¶:
    #   - ä»…åœ¨ç¼–è¯‘æˆåŠŸæ—¶æ‰§è¡Œ
    # ------------------------------------------------------------------------
    - name: ğŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success'  # ä»…åœ¨ç¼–è¯‘æˆåŠŸæ—¶æ‰§è¡Œ
      run: |
        output=$(bash scripts/08-organize-files.sh)
        echo "$output"
        # æå– FIRMWARE_DIR ç¯å¢ƒå˜é‡
        FIRMWARE_DIR=$(echo "$output" | grep "FIRMWARE_DIR=" | cut -d'=' -f2)
        echo "FIRMWARE=$FIRMWARE_DIR" >> $GITHUB_ENV
        # ç”Ÿæˆæ—¥æœŸæ ‡è¯†ï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
        BUILD_DATE=$(TZ=Asia/Shanghai date '+%Y-%m-%d')
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 10: ï¿½ ä¸Šä¼ å›ºä»¶åˆ° Artifactsï¼ˆå¤‡ä»½ï¼‰
    # ------------------------------------------------------------------------
    # ä½¿ç”¨ GitHub Actions å®˜æ–¹ä¸Šä¼ åŠ¨ä½œ
    # åŠŸèƒ½:
    #   - å°†ç¼–è¯‘å¥½çš„å›ºä»¶ä¸Šä¼ åˆ° GitHub Artifactsï¼ˆä½œä¸ºå¤‡ä»½ï¼‰
    #   - ä¿ç•™æ—¶é—´: 90 å¤©
    # å‘½åæ ¼å¼:
    #   - OpenWrt_å›ºä»¶_YYYY-MM-DDï¼ˆæŒ‰æ—¥æœŸå‘½åï¼‰
    # æ¡ä»¶:
    #   - ä»…åœ¨å›ºä»¶æ•´ç†æˆåŠŸæ—¶æ‰§è¡Œ
    # ------------------------------------------------------------------------
    - name: ï¿½ ä¸Šä¼ å›ºä»¶åˆ° Artifacts
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_å›ºä»¶_${{ steps.organize.outputs.BUILD_DATE }}
        path: ${{ env.FIRMWARE }}

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 11: ğŸš€ å‘å¸ƒåˆ° GitHub Releases
    # ------------------------------------------------------------------------
    # åˆ›å»º GitHub Release å¹¶ä¸Šä¼ å›ºä»¶
    # åŠŸèƒ½:
    #   - åˆ›å»ºæ–°çš„ Releaseï¼ˆæŒ‰æ—¥æœŸå‘½åï¼‰
    #   - ä¸Šä¼ æ‰€æœ‰å›ºä»¶æ–‡ä»¶åˆ° Release
    #   - æ°¸ä¹…ä¿å­˜ï¼Œæ–¹ä¾¿ä¸‹è½½
    # Release åç§°:
    #   - ImmortalWrt-IPQ60xx-YYYY-MM-DD
    # Tag åç§°:
    #   - v-YYYY-MM-DD
    # æ¡ä»¶:
    #   - ä»…åœ¨å›ºä»¶æ•´ç†æˆåŠŸæ—¶æ‰§è¡Œ
    # ------------------------------------------------------------------------
    - name: ğŸš€ å‘å¸ƒåˆ° GitHub Releases
      uses: softprops/action-gh-release@v1
      if: steps.organize.outputs.status == 'success'
      with:
        tag_name: op-${{ steps.organize.outputs.BUILD_DATE }}
        name: ImmortalWrt IPQ60xx å›ºä»¶ ${{ steps.organize.outputs.BUILD_DATE }}
        body: |
          ## ğŸ“¦ ImmortalWrt å›ºä»¶å‘å¸ƒ
          
          ### ğŸ¯ ç›®æ ‡è®¾å¤‡
          - äº¬ä¸œäº‘ äºšç‘Ÿï¼ˆRE-SS-01ï¼‰
          - äº¬ä¸œäº‘ é›…å…¸å¨œï¼ˆRE-CS-02ï¼‰
          
          ### âœ¨ æ ¸å¿ƒç‰¹æ€§
          - âœ… **APK åŒ…ç®¡ç†å™¨**ï¼ˆæ–°ä¸€ä»£åŒ…ç®¡ç†ï¼‰
          - âœ… **HomeProxy**ï¼ˆä»£ç†ç®¡ç†ï¼‰
          - âœ… **Lucky**ï¼ˆç»¼åˆå·¥å…·ç®±ï¼‰
          - âœ… **AdGuardHome**ï¼ˆå¹¿å‘Šæ‹¦æˆªï¼‰
          - âœ… **EasyTier**ï¼ˆç»„ç½‘å·¥å…·ï¼‰
          - âœ… **Aurora ä¸»é¢˜**ï¼ˆç°ä»£åŒ–ç•Œé¢ï¼‰
          - âœ… **æµé‡ç›‘æ§**ï¼ˆnlbwmon + wrtbwmonï¼‰
          
          ### ğŸ“Š æ„å»ºä¿¡æ¯
          - ğŸ• æ„å»ºæ—¶é—´ï¼š${{ steps.organize.outputs.BUILD_DATE }}
          - ğŸ·ï¸ æ„å»ºç¼–å·ï¼š#${{ github.run_number }}
          - ğŸŒ³ æºç åˆ†æ”¯ï¼š${{ env.REPO_BRANCH }}
          - ğŸ–¥ï¸ è¿è¡Œç¯å¢ƒï¼š${{ matrix.os }}
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡å‹å·ä¸‹è½½å¯¹åº”çš„å›ºä»¶æ–‡ä»¶ï¼š
          - **é›…å…¸å¨œï¼ˆRE-CS-02ï¼‰**ï¼šé€‰æ‹©åŒ…å« `re-cs-02` çš„æ–‡ä»¶
          - **äºšç‘Ÿï¼ˆRE-SS-01ï¼‰**ï¼šé€‰æ‹©åŒ…å« `re-ss-01` çš„æ–‡ä»¶
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡åˆ·æœºè¯·ä½¿ç”¨ `factory` å›ºä»¶
          - å‡çº§å›ºä»¶è¯·ä½¿ç”¨ `sysupgrade` å›ºä»¶
          - åˆ·æœºå‰è¯·å¤‡ä»½é‡è¦æ•°æ®
        files: ${{ env.FIRMWARE }}/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ------------------------------------------------------------------------
    # æ­¥éª¤ 12: ğŸ“‹ ç”Ÿæˆæ„å»ºæ‘˜è¦
    # ------------------------------------------------------------------------
    # è¾“å‡ºæ„å»ºæ‘˜è¦ä¿¡æ¯åˆ° GitHub Actions Summaryï¼Œæ–¹ä¾¿æŸ¥çœ‹
    # ------------------------------------------------------------------------
    - name: ğŸ“‹ ç”Ÿæˆæ„å»ºæ‘˜è¦
      if: steps.compile.outputs.status == 'success'
      run: |
        echo "## ğŸ‰ å›ºä»¶æ„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ• æ„å»ºæ—¶é—´: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ·ï¸ æ„å»ºç¼–å·: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ³ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ–¥ï¸ è¿è¡Œç¯å¢ƒ: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ’¾ å›ºä»¶è·¯å¾„: \`${{ env.FIRMWARE }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¦ å›ºä»¶åç§°: OpenWrt_å›ºä»¶_${{ steps.organize.outputs.BUILD_DATE }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¥ ä¸‹è½½å›ºä»¶" >> $GITHUB_STEP_SUMMARY
        echo "åœ¨å½“å‰é¡µé¢çš„ **Artifacts** åŒºåŸŸä¸‹è½½ç¼–è¯‘å¥½çš„å›ºä»¶" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ä»»åŠ¡: ğŸ§¹ æ¸…ç†æ—§çš„æ„å»ºè®°å½•
  # ============================================================================
  # åŠŸèƒ½:
  #   - è‡ªåŠ¨åˆ é™¤æ—§çš„ Workflow Runsï¼ŒèŠ‚çœ GitHub Actions å­˜å‚¨ç©ºé—´
  #   - ç­–ç•¥: åªä¿ç•™æœ€è¿‘ 3 æ¬¡æ„å»º
  # ============================================================================
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    if: always() # æ— è®ºæ„å»ºæˆåŠŸä¸å¦éƒ½è¿è¡Œ
    needs: build # åœ¨æ„å»ºä»»åŠ¡ä¹‹åè¿è¡Œ
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 3
