name: ğŸ§ª æµ‹è¯•å›ºä»¶æ•´ç†è„šæœ¬

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  test:
    runs-on: ubuntu-24.04
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ åˆ›å»ºæ¨¡æ‹Ÿå›ºä»¶ç›®å½•ç»“æ„
        run: |
          echo "åˆ›å»ºæ¨¡æ‹Ÿçš„ OpenWrt æ„å»ºè¾“å‡ºç›®å½•..."
          mkdir -p openwrt/bin/targets/qualcommax/ipq60xx
          cd openwrt/bin/targets/qualcommax/ipq60xx
          
          # åˆ›å»ºæ¨¡æ‹Ÿçš„å›ºä»¶æ–‡ä»¶
          echo "Creating mock firmware files..."
          touch immortalwrt-qualcommax-ipq60xx-jdcloud_re-cs-02-squashfs-sysupgrade.bin
          touch immortalwrt-qualcommax-ipq60xx-jdcloud_re-cs-02-squashfs-factory.bin
          touch immortalwrt-qualcommax-ipq60xx-jdcloud_re-ss-01-squashfs-sysupgrade.bin
          touch immortalwrt-qualcommax-ipq60xx-jdcloud_re-ss-01-squashfs-factory.bin
          
          # åˆ›å»ºæ¨¡æ‹Ÿçš„å…ƒæ•°æ®æ–‡ä»¶
          echo "Creating mock metadata files..."
          touch config.buildinfo
          touch feeds.buildinfo
          touch immortalwrt-qualcommax-ipq60xx.manifest
          touch sha256sums
          touch version.buildinfo
          
          # åˆ›å»º packages ç›®å½•ï¼ˆç”¨äºæµ‹è¯•åˆ é™¤åŠŸèƒ½ï¼‰
          mkdir -p packages/test
          touch packages/test/dummy.ipk
          
          echo "æ¨¡æ‹Ÿç›®å½•ç»“æ„åˆ›å»ºå®Œæˆï¼"
          echo ""
          echo "ç›®å½•å†…å®¹ï¼š"
          ls -lhR
      
      - name: ğŸ“¦ æµ‹è¯•å›ºä»¶æ•´ç†è„šæœ¬
        run: |
          # åˆ‡æ¢åˆ°æ­£ç¡®çš„ç›®å½•
          cd $GITHUB_WORKSPACE
          
          # è¿è¡Œæ•´ç†è„šæœ¬
          bash scripts/08-organize-files.sh
      
      - name: ğŸ“Š éªŒè¯ç»“æœ
        run: |
          cd openwrt/bin/targets/qualcommax/ipq60xx
          
          echo "========================================="
          echo "éªŒè¯ç»“æœï¼š"
          echo "========================================="
          
          # æ£€æŸ¥å›ºä»¶æ–‡ä»¶æ•°é‡
          BIN_COUNT=$(find . -name "*.bin" | wc -l)
          echo "æ‰¾åˆ° .bin æ–‡ä»¶æ•°é‡: $BIN_COUNT"
          
          # æ£€æŸ¥ packages ç›®å½•æ˜¯å¦è¢«åˆ é™¤
          if [ -d "packages" ]; then
            echo "âŒ packages ç›®å½•ä»ç„¶å­˜åœ¨ï¼ˆåº”è¯¥è¢«åˆ é™¤ï¼‰"
            exit 1
          else
            echo "âœ… packages ç›®å½•å·²æ­£ç¡®åˆ é™¤"
          fi
          
          # éªŒè¯å›ºä»¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ $BIN_COUNT -ge 4 ]; then
            echo "âœ… æµ‹è¯•é€šè¿‡ï¼šæ‰¾åˆ°æ‰€æœ‰å›ºä»¶æ–‡ä»¶ï¼"
          else
            echo "âŒ æµ‹è¯•å¤±è´¥ï¼šå›ºä»¶æ–‡ä»¶æ•°é‡ä¸æ­£ç¡®"
            exit 1
          fi
          
          echo ""
          echo "æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼âœ…"
