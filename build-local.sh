#!/bin/bash
#
# ============================================================================
# 脚本名称: build-local.sh
# 功能描述: 本地构建 ImmortalWrt 固件（完整流程）
# ============================================================================
# 作用:
#   按顺序执行所有构建脚本，完整复现 GitHub Actions 的构建流程
# ============================================================================
# 使用方法:
#   chmod +x build-local.sh
#   ./build-local.sh
# ============================================================================
# 环境要求:
#   - Linux/WSL2 环境
#   - sudo 权限（安装依赖）
#   - 至少 60GB 可用磁盘空间
#   - 推荐 8 核 16GB 内存
# ============================================================================
#

set -e  # 遇到错误立即退出

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "========================================="
echo "🚀 ImmortalWrt 本地构建流程"
echo "========================================="
echo ""

# ----------------------------------------------------------------------------
# 设置环境变量
# ----------------------------------------------------------------------------
echo "📝 设置环境变量..."
export REPO_URL="https://github.com/immortalwrt/immortalwrt"
export REPO_BRANCH="master"
export FEEDS_CONF="feeds.conf.default"
export CONFIG_FILE="seed.config"
export TZ="Asia/Shanghai"

# 检测工作目录
if [ ! -d "/workdir" ]; then
    echo -e "${YELLOW}⚠️  /workdir 不存在，将使用当前目录作为工作目录${NC}"
    export WORKDIR="$PWD/openwrt-build"
    mkdir -p "$WORKDIR"
else
    export WORKDIR="/workdir"
fi

echo "📁 工作目录: $WORKDIR"
echo ""

# ----------------------------------------------------------------------------
# 步骤 1: 初始化编译环境
# ----------------------------------------------------------------------------
echo "========================================="
echo "步骤 1/9: 🔧 初始化编译环境"
echo "========================================="
if [ -f "scripts/01-init-environment.sh" ]; then
    bash scripts/01-init-environment.sh
else
    echo -e "${RED}❌ 错误：scripts/01-init-environment.sh 不存在${NC}"
    exit 1
fi
echo ""

# ----------------------------------------------------------------------------
# 步骤 2: 克隆源码
# ----------------------------------------------------------------------------
echo "========================================="
echo "步骤 2/9: 📦 克隆 ImmortalWrt 源码"
echo "========================================="
cd "$WORKDIR"
if [ ! -d "openwrt" ]; then
    bash "$OLDPWD/scripts/02-clone-source.sh"
else
    echo "⏭️  源码目录已存在，跳过克隆"
fi
echo ""

# ----------------------------------------------------------------------------
# 步骤 3: 更新 Feeds
# ----------------------------------------------------------------------------
echo "========================================="
echo "步骤 3/9: 🔄 更新 Feeds"
echo "========================================="
bash "$OLDPWD/scripts/03-update-feeds.sh"
echo ""

# ----------------------------------------------------------------------------
# 步骤 4: 克隆第三方插件
# ----------------------------------------------------------------------------
echo "========================================="
echo "步骤 4/9: 📦 克隆第三方插件"
echo "========================================="
bash "$OLDPWD/scripts/03.5-clone-plugins.sh"
echo ""

# ----------------------------------------------------------------------------
# 步骤 5: 清理冲突插件
# ----------------------------------------------------------------------------
echo "========================================="
echo "步骤 5/9: 🧹 清理冲突插件"
echo "========================================="
bash "$OLDPWD/scripts/04-clean-conflicts.sh"
echo ""

# ----------------------------------------------------------------------------
# 步骤 6: 加载配置文件
# ----------------------------------------------------------------------------
echo "========================================="
echo "步骤 6/9: ⚙️  加载配置文件"
echo "========================================="
bash "$OLDPWD/scripts/05-load-config.sh"
echo ""

# ----------------------------------------------------------------------------
# 步骤 7: 下载依赖
# ----------------------------------------------------------------------------
echo "========================================="
echo "步骤 7/9: 📥 下载编译依赖"
echo "========================================="
bash "$OLDPWD/scripts/06-download-libs.sh"
echo ""

# ----------------------------------------------------------------------------
# 步骤 8: 编译固件
# ----------------------------------------------------------------------------
echo "========================================="
echo "步骤 8/9: 🔨 编译固件"
echo "========================================="
bash "$OLDPWD/scripts/07-compile.sh"
echo ""

# ----------------------------------------------------------------------------
# 步骤 9: 整理固件
# ----------------------------------------------------------------------------
echo "========================================="
echo "步骤 9/9: 📦 整理固件文件"
echo "========================================="
output=$(bash "$OLDPWD/scripts/08-organize-files.sh")
echo "$output"

# 提取固件目录
FIRMWARE_DIR=$(echo "$output" | grep "FIRMWARE_DIR=" | cut -d'=' -f2)

echo ""
echo "========================================="
echo "✅ 构建完成！"
echo "========================================="
echo -e "${GREEN}固件位置: $FIRMWARE_DIR${NC}"
echo ""
echo "请检查固件目录中的 .bin 文件。"
echo ""
